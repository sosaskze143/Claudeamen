<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخالفات</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background-color: #f7f7f7;
            direction: rtl;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #0b4f8c;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            color: #0b4f8c;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button, .btn {
            background-color: #0b4f8c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover, .btn:hover {
            background-color: #083b6f;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        table th, table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            text-align: right;
        }
        
        table th {
            background-color: #0b4f8c;
            color: white;
        }
        
        table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .dashboard {
            display: flex;
        }
        
        .sidebar {
            width: 250px;
            background-color: #0b4f8c;
            color: white;
            padding: 20px;
            min-height: calc(100vh - 70px);
            border-radius: 5px;
        }
        
        .sidebar ul {
            list-style: none;
        }
        
        .sidebar li {
            margin-bottom: 15px;
        }
        
        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background-color: #083b6f;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-form input {
            flex: 1;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-unpaid {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-accepted {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: #0b4f8c;
        }
        
        .hidden {
            display: none;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- سيتم تحميل المحتوى ديناميكيًا -->
    </div>

    <script>
        // بيانات التطبيق
        const appData = {
            currentUser: null,
            users: [
                { id: "admin", password: "admin", name: "مدير النظام", role: "admin" }
            ],
            citizens: [],
            violations: [],
            activeTab: 'dashboard',
            searchQuery: '',
            searchType: 'name',
            selectedViolation: null,
            objectionText: '',
            newCitizen: {
                name: '',
                id: '',
                phone: '',
                password: ''
            },
            newViolation: {
                citizenId: '',
                date: new Date().toISOString().split('T')[0],
                type: 'سرعة',
                details: '',
                amount: 500,
                paid: false,
                objection: null
            },
            violationTypes: [
                'سرعة',
                'تجاوز إشارة حمراء',
                'وقوف في مكان ممنوع',
                'عدم ربط حزام الأمان',
                'استخدام الهاتف أثناء القيادة',
                'عدم حمل رخصة قيادة',
                'قيادة بدون تأمين',
                'مخالفة مرورية أخرى'
            ]
        };

        // إنشاء واجهة تسجيل الدخول
        function renderLoginPage() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <header>
                        <h1>نظام إدارة المخالفات</h1>
                    </header>
                    <div class="login-form">
                        <h2>تسجيل الدخول</h2>
                        <div class="form-group">
                            <label for="username">اسم المستخدم / رقم الهوية</label>
                            <input type="text" id="username" placeholder="أدخل اسم المستخدم أو رقم الهوية">
                        </div>
                        <div class="form-group">
                            <label for="password">كلمة المرور</label>
                            <input type="password" id="password" placeholder="أدخل كلمة المرور">
                        </div>
                        <button id="login-btn" class="btn">تسجيل الدخول</button>
                        <p id="login-error" style="color: red; margin-top: 15px; display: none;">بيانات تسجيل الدخول غير صحيحة</p>
                    </div>
                </div>
            `;

            // إضافة حدث النقر على زر تسجيل الدخول
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // إضافة حدث الضغط على مفتاح Enter
            document.getElementById('password').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleLogin();
                }
            });
        }

        // معالجة تسجيل الدخول
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('login-error');
            
            // التحقق من بيانات المدير
            if (username === 'admin' && password === 'admin') {
                appData.currentUser = { id: 'admin', name: 'مدير النظام', role: 'admin' };
                renderAdminDashboard();
                return;
            }
            
            // التحقق من بيانات المواطن
            const citizen = appData.citizens.find(c => c.id === username && c.password === password);
            if (citizen) {
                appData.currentUser = { ...citizen, role: 'citizen' };
                renderCitizenDashboard();
                return;
            }
            
            // في حالة عدم تطابق البيانات
            errorMessage.style.display = 'block';
        }

        // إنشاء واجهة المدير
        function renderAdminDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <header>
                        <h1>نظام إدارة المخالفات - لوحة تحكم المدير</h1>
                    </header>
                    <div class="dashboard">
                        <div class="sidebar">
                            <ul>
                                <li><a href="#" id="tab-dashboard" class="active">الرئيسية</a></li>
                                <li><a href="#" id="tab-citizens">إدارة المواطنين</a></li>
                                <li><a href="#" id="tab-violations">إدارة المخالفات</a></li>
                                <li><a href="#" id="tab-objections">الاعتراضات</a></li>
                                <li><a href="#" id="tab-reports">التقارير</a></li>
                                <li><a href="#" id="logout">تسجيل الخروج</a></li>
                            </ul>
                        </div>
                        <div class="main-content">
                            <div id="content-dashboard">
                                <h2>لوحة المعلومات</h2>
                                <div class="dashboard-cards">
                                    <div class="stat-card">
                                        <h3>إجمالي المواطنين</h3>
                                        <div class="number">${appData.citizens.length}</div>
                                    </div>
                                    <div class="stat-card">
                                        <h3>إجمالي المخالفات</h3>
                                        <div class="number">${appData.violations.length}</div>
                                    </div>
                                    <div class="stat-card">
                                        <h3>المخالفات غير المدفوعة</h3>
                                        <div class="number">${appData.violations.filter(v => !v.paid).length}</div>
                                    </div>
                                    <div class="stat-card">
                                        <h3>الاعتراضات بانتظار الرد</h3>
                                        <div class="number">${appData.violations.filter(v => v.objection && v.objection.status === 'pending').length}</div>
                                    </div>
                                </div>
                                <div class="card">
                                    <h3>آخر المخالفات المسجلة</h3>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>اسم المواطن</th>
                                                <th>نوع المخالفة</th>
                                                <th>التاريخ</th>
                                                <th>المبلغ</th>
                                                <th>حالة الدفع</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${renderLastViolations()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="content-citizens" class="hidden">
                                <h2>إدارة المواطنين</h2>
                                <div class="card">
                                    <h3>إضافة مواطن جديد</h3>
                                    <div class="form-group">
                                        <label for="citizen-name">الاسم الكامل</label>
                                        <input type="text" id="citizen-name" placeholder="أدخل اسم المواطن">
                                    </div>
                                    <div class="form-group">
                                        <label for="citizen-id">رقم الهوية الوطنية</label>
                                        <input type="text" id="citizen-id" placeholder="أدخل رقم الهوية">
                                    </div>
                                    <div class="form-group">
                                        <label for="citizen-phone">رقم الجوال (اختياري)</label>
                                        <input type="text" id="citizen-phone" placeholder="أدخل رقم الجوال">
                                    </div>
                                    <div class="form-group">
                                        <label for="citizen-password">كلمة المرور</label>
                                        <input type="password" id="citizen-password" placeholder="أدخل كلمة المرور">
                                    </div>
                                    <button id="add-citizen-btn" class="btn">إضافة مواطن</button>
                                </div>
                                <div class="card">
                                    <h3>قائمة المواطنين</h3>
                                    <div class="search-form">
                                        <input type="text" id="search-citizens" placeholder="ابحث عن مواطن...">
                                        <button id="search-citizens-btn" class="btn">بحث</button>
                                    </div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>الاسم</th>
                                                <th>رقم الهوية</th>
                                                <th>رقم الجوال</th>
                                                <th>عدد المخالفات</th>
                                                <th>إجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="citizens-table">
                                            ${renderCitizensTable()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="content-violations" class="hidden">
                                <h2>إدارة المخالفات</h2>
                                <div class="card">
                                    <h3>تسجيل مخالفة جديدة</h3>
                                    <div class="form-group">
                                        <label for="violation-citizen">المواطن</label>
                                        <select id="violation-citizen">
                                            <option value="">اختر المواطن</option>
                                            ${appData.citizens.map(c => `<option value="${c.id}">${c.name} - ${c.id}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="violation-date">التاريخ</label>
                                        <input type="date" id="violation-date" value="${new Date().toISOString().split('T')[0]}">
                                    </div>
                                    <div class="form-group">
                                        <label for="violation-type">نوع المخالفة</label>
                                        <select id="violation-type">
                                            ${appData.violationTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="violation-details">تفاصيل المخالفة</label>
                                        <textarea id="violation-details" rows="3" placeholder="أدخل تفاصيل المخالفة"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="violation-amount">المبلغ</label>
                                        <input type="number" id="violation-amount" value="500">
                                    </div>
                                    <button id="add-violation-btn" class="btn">تسجيل المخالفة</button>
                                </div>
                                <div class="card">
                                    <h3>قائمة المخالفات</h3>
                                    <div class="search-form">
                                        <input type="text" id="search-violations" placeholder="ابحث عن مخالفة...">
                                        <select id="search-type">
                                            <option value="name">اسم المواطن</option>
                                            <option value="id">رقم الهوية</option>
                                            <option value="type">نوع المخالفة</option>
                                        </select>
                                        <select id="filter-status">
                                            <option value="all">جميع الحالات</option>
                                            <option value="paid">مدفوعة</option>
                                            <option value="unpaid">غير مدفوعة</option>
                                            <option value="objection">عليها اعتراض</option>
                                        </select>
                                        <button id="search-violations-btn" class="btn">بحث</button>
                                    </div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>اسم المواطن</th>
                                                <th>نوع المخالفة</th>
                                                <th>التاريخ</th>
                                                <th>المبلغ</th>
                                                <th>حالة الدفع</th>
                                                <th>حالة الاعتراض</th>
                                                <th>إجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="violations-table">
                                            ${renderViolationsTable()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="content-objections" class="hidden">
                                <h2>إدارة الاعتراضات</h2>
                                <div class="card">
                                    <h3>الاعتراضات بانتظار الرد</h3>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>اسم المواطن</th>
                                                <th>نوع المخالفة</th>
                                                <th>التاريخ</th>
                                                <th>المبلغ</th>
                                                <th>نص الاعتراض</th>
                                                <th>إجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="objections-table">
                                            ${renderObjectionsTable()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="content-reports" class="hidden">
                                <h2>التقارير</h2>
                                <div class="dashboard-cards">
                                    <div class="stat-card">
                                        <h3>إجمالي المخالفات</h3>
                                        <div class="number">${appData.violations.length}</div>
                                    </div>
                                    <div class="stat-card">
                                        <h3>إجمالي المبالغ المستحقة</h3>
                                        <div class="number">${getTotalDueAmount()} ريال</div>
                                    </div>
                                    <div class="stat-card">
                                        <h3>المبالغ المدفوعة</h3>
                                        <div class="number">${getTotalPaidAmount()} ريال</div>
                                    </div>
                                    <div class="stat-card">
                                        <h3>عدد الاعتراضات</h3>
                                        <div class="number">${getObjectionsCount()}</div>
                                    </div>
                                </div>
                                <div class="card">
                                    <h3>أكثر أنواع المخالفات تكرارًا</h3>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>نوع المخالفة</th>
                                                <th>عدد المرات</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${renderMostFrequentViolations()}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="card">
                                    <h3>أكثر المواطنين مخالفةً</h3>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>اسم المواطن</th>
                                                <th>رقم الهوية</th>
                                                <th>عدد المخالفات</th>
                                                <th>إجمالي المبالغ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${renderMostViolatingCitizens()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // إضافة أحداث التبويبات
            document.getElementById('tab-dashboard').addEventListener('click', () => switchTab('dashboard'));
            document.getElementById('tab-citizens').addEventListener('click', () => switchTab('citizens'));
            document.getElementById('tab-violations').addEventListener('click', () => switchTab('violations'));
            document.getElementById('tab-objections').addEventListener('click', () => switchTab('objections'));
            document.getElementById('tab-reports').addEventListener('click', () => switchTab('reports'));
            document.getElementById('logout').addEventListener('click', handleLogout);
            
            // إضافة أحداث لإضافة مواطن جديد
            document.getElementById('add-citizen-btn').addEventListener('click', addNewCitizen);
            
            // إضافة أحداث لإضافة مخالفة جديدة
            document.getElementById('add-violation-btn').addEventListener('click', addNewViolation);
            
            // إضافة أحداث للبحث
            document.getElementById('search-citizens-btn').addEventListener('click', searchCitizens);
            document.getElementById('search-violations-btn').addEventListener('click', searchViolations);
        }

        // إنشاء واجهة المواطن
        function renderCitizenDashboard() {
            const citizen = appData.currentUser;
            const citizenViolations = appData.violations.filter(v => v.citizenId === citizen.id);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <header>
                        <h1>نظام إدارة المخالفات - صفحة المواطن</h1>
                    </header>
                    <div class="card">
                        <h2>مرحبًا، ${citizen.name}</h2>
                        <p>رقم الهوية: ${citizen.id}</p>
                    </div>
                    <div class="card">
                        <h3>مخالفاتك (${citizenViolations.length})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>نوع المخالفة</th>
                                    <th>التاريخ</th>
                                    <th>التفاصيل</th>
                                    <th>المبلغ</th>
                                    <th>حالة الدفع</th>
                                    <th>حالة الاعتراض</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderCitizenViolations(citizen.id)}
                            </tbody>
                        </table>
                    </div>
                    <div id="objection-form" class="card hidden">
                        <h3>تقديم اعتراض</h3>
                        <div class="form-group">
                            <label for="objection-text">نص الاعتراض</label>
                            <textarea id="objection-text" rows="4" placeholder="أدخل سبب الاعتراض..."></textarea>
                        </div>
                        <div>
                            <button id="submit-objection-btn" class="btn">إرسال الاعتراض</button>
                            <button id="cancel-objection-btn" class="btn btn-danger">إلغاء</button>
                        </div>
                    </div>
                    <div class="card">
                        <button id="logout-btn" class="btn btn-danger">تسجيل الخروج</button>
                    </div>
                </div>
            `;
            
            // إضافة أحداث أزرار الاعتراض
            document.querySelectorAll('.object-btn').forEach(btn => {
                btn.addEventListener('click', () => showObjectionForm(btn.getAttribute('data-id')));
            });
            
            // إضافة حدث زر تسجيل الخروج
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // أزرار نموذج الاعتراض
            const objectionForm = document.getElementById('objection-form');
            const submitBtn = document.getElementById('submit-objection-btn');
            const cancelBtn = document.getElementById('cancel-objection-btn');
            
            if (submitBtn) {
                submitBtn.addEventListener('click', submitObjection);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    objectionForm.classList.add('hidden');
                    appData.selectedViolation = null;
                });
            }
        }

        // عرض آخر المخالفات في لوحة المعلومات
        function renderLastViolations() {
            const lastViolations = [...appData.violations].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (lastViolations.length === 0) {
                return '<tr><td colspan="5" style="text-align: center;">لا توجد مخالفات مسجلة</td></tr>';
            }
            
            return lastViolations.map(v => {
                const citizen = appData.citizens.find(c => c.id === v.citizenId) || { name: 'غير معروف' };
                return `
                    <tr>
                        <td>${citizen.name}</td>
                        <td>${v.type}</td>
                        <td>${formatDate(v.date)}</td>
                        <td>${v.amount} ريال</td>
                        <td>
                            <span class="status ${v.paid ? 'status-paid' : 'status-unpaid'}">${v.paid ? 'مدفوعة' : 'غير مدفوعة'}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // عرض جدول المواطنين
        function renderCitizensTable() {
            if (appData.citizens.length === 0) {
                return '<tr><td colspan="5" style="text-align: center;">لا يوجد مواطنين مسجلين</td></tr>';
            }
            
            return appData.citizens.map(citizen => {
                const violationsCount = appData.violations.filter(v => v.citizenId === citizen.id).length;
                return `
                    <tr>
                        <td>${citizen.name}</td>
                        <td>${citizen.id}</td>
                        <td>${citizen.phone || 'غير متوفر'}</td>
                        <td>${violationsCount}</td>
                        <td>
                            <button class="btn btn-warning view-citizen-violations" data-id="${citizen.id}">عرض المخالفات</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // عرض جدول المخالفات
        function renderViolationsTable() {
            if (appData.violations.length === 0) {
                return '<tr><td colspan="7" style="text-align: center;">لا توجد مخالفات مسجلة</td></tr>';
            }
            
            return appData.violations.map(v => {
                const citizen = appData.citizens.find(c => c.id === v.citizenId) || { name: 'غير معروف' };
                let objectionStatus = 'لا يوجد';
                
                if (v.objection) {
                    if (v.objection.status === 'pending') {
                        objectionStatus = 'بانتظار الرد';
                    } else if (v.objection.status === 'accepted') {
                        objectionStatus = 'مقبول';
                    } else if (v.objection.status === 'rejected') {
                        objectionStatus = 'مرفوض';
                    }
                }
                
                return `
                    <tr>
                        <td>${citizen.name}</td>
                        <td>${v.type}</td>
                        <td>${formatDate(v.date)}</td>
                        <td>${v.amount} ريال</td>
                        <td>
                            <span class="status ${v.paid ? 'status-paid' : 'status-unpaid'}">${v.paid ? 'مدفوعة' : 'غير مدفوعة'}</span>
                        </td>
                        <td>
                            <span class="status ${getObjectionStatusClass(v.objection)}">${objectionStatus}</span>
                        </td>
                        <td>
                            <button class="btn view-violation" data-id="${v.id}">عرض</button>
                            <button class="btn ${v.paid ? 'btn-warning mark-unpaid' : 'btn-success mark-paid'}" data-id="${v.id}">
                                ${v.paid ? 'تعديل لغير مدفوعة' : 'تعديل لمدفوعة'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // عرض جدول الاعتراضات
        function renderObjectionsTable() {
            const pendingObjections = appData.violations.filter(v => v.objection && v.objection.status === 'pending');
            
            if (pendingObjections.length === 0) {
                return '<tr><td colspan="6" style="text-align: center;">لا توجد اعتراضات بانتظار الرد</td></tr>';
            }
            
            return pendingObjections.map(v => {
                const citizen = appData.citizens.find(c => c.id === v.citizenId) || { name: 'غير معروف' };
                
                return `
                    <tr>
                        <td>${citizen.name}</td>
                        <td>${v.type}</td>
                        <td>${formatDate(v.date)}</td>
                        <td>${v.amount} ريال</td>
                        <td>${v.objection.text}</td>
                        <td>
                            <button class="btn btn-success accept-objection" data-id="${v.id}">قبول</button>
                            <button class="btn btn-danger reject-objection" data-id="${v.id}">رفض</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // عرض مخالفات المواطن
        function renderCitizenViolations(citizenId) {
            const violations = appData.violations.filter(v => v.citizenId === citizenId);
            
            if (violations.length === 0) {
                return '<tr><td colspan="7" style="text-align: center;">لا توجد مخالفات مسجلة</td></tr>';
            }
            
            return violations.map(v => {
                let objectionStatus = 'لا يوجد';
                let canObject = true;
                
                if (v.objection) {
                    canObject = false;
                    if (v.objection.status === 'pending') {
                        objectionStatus = 'بانتظار الرد';
                    } else if (v.objection.status === 'accepted') {
                        objectionStatus = 'مقبول';
                    } else if (v.objection.status === 'rejected') {
                        objectionStatus = 'مرفوض';
                    }
                }
                
                return `
                    <tr>
                        <td>${v.type}</td>
                        <td>${formatDate(v.date)}</td>
                        <td>${v.details}</td>
                        <td>${v.amount} ريال</td>
                        <td>
                            <span class="status ${v.paid ? 'status-paid' : 'status-unpaid'}">${v.paid ? 'مدفوعة' : 'غير مدفوعة'}</span>
                        </td>
                        <td>
                            <span class="status ${getObjectionStatusClass(v.objection)}">${objectionStatus}</span>
                        </td>
                        <td>
                            ${canObject ? `<button class="btn object-btn" data-id="${v.id}">اعتراض</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // عرض أكثر أنواع المخالفات تكرارًا
        function renderMostFrequentViolations() {
            const violationCounts = {};
            
            appData.violations.forEach(v => {
                if (!violationCounts[v.type]) {
                    violationCounts[v.type] = 0;
                }
                violationCounts[v.type]++;
            });
            
            const sortedTypes = Object.keys(violationCounts).sort((a, b) => violationCounts[b] - violationCounts[a]);
            
            if (sortedTypes.length === 0) {
                return '<tr><td colspan="2" style="text-align: center;">لا توجد مخالفات مسجلة</td></tr>';
            }
            
            return sortedTypes.map(type => `
                <tr>
                    <td>${type}</td>
                    <td>${violationCounts[type]}</td>
                </tr>
            `).join('');
        }

        // عرض أكثر المواطنين مخالفةً
        function renderMostViolatingCitizens() {
            const citizenViolations = {};
            
            appData.citizens.forEach(citizen => {
                const violations = appData.violations.filter(v => v.citizenId === citizen.id);
                const totalAmount = violations.reduce((sum, v) => sum + v.amount, 0);
                
                citizenViolations[citizen.id] = {
                    name: citizen.name,
                    id: citizen.id,
                    count: violations.length,
                    totalAmount: totalAmount
                };
            });
            
            const sortedCitizens = Object.values(citizenViolations)
                .sort((a, b) => b.count - a.count)
                .filter(c => c.count > 0)
                .slice(0, 5);
            
            if (sortedCitizens.length === 0) {
                return '<tr><td colspan="4" style="text-align: center;">لا توجد مخالفات مسجلة</td></tr>';
            }
            
            return sortedCitizens.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.id}</td>
                    <td>${c.count}</td>
                    <td>${c.totalAmount} ريال</td>
                </tr>
            `).join('');
        }

        // إضافة مواطن جديد
        function addNewCitizen() {
            const name = document.getElementById('citizen-name').value.trim();
            const id = document.getElementById('citizen-id').value.trim();
            const phone = document.getElementById('citizen-phone').value.trim();
            const password = document.getElementById('citizen-password').value.trim();
            
            if (!name || !id || !password) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // التحقق من عدم وجود مواطن بنفس رقم الهوية
            if (appData.citizens.some(c => c.id === id)) {
                alert('يوجد مواطن مسجل بنفس رقم الهوية');
                return;
            }
            
            // إضافة المواطن الجديد
            const newCitizen = {
                name,
                id,
                phone,
                password
            };
            
            appData.citizens.push(newCitizen);
            
            // تحديث جدول المواطنين
            document.getElementById('citizens-table').innerHTML = renderCitizensTable();
            
            // مسح الحقول
            document.getElementById('citizen-name').value = '';
            document.getElementById('citizen-id').value = '';
            document.getElementById('citizen-phone').value = '';
            document.getElementById('citizen-password').value = '';
            
            alert('تمت إضافة المواطن بنجاح');
        }

        // إضافة مخالفة جديدة
        function addNewViolation() {
            const citizenId = document.getElementById('violation-citizen').value;
            const date = document.getElementById('violation-date').value;
            const type = document.getElementById('violation-type').value;
            const details = document.getElementById('violation-details').value;
            const amount = parseInt(document.getElementById('violation-amount').value);
            
            if (!citizenId || !date || !type || !details || isNaN(amount)) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // إضافة المخالفة الجديدة
            const newViolation = {
                id: generateId(),
                citizenId,
                date,
                type,
                details,
                amount,
                paid: false,
                objection: null
            };
            
            appData.violations.push(newViolation);
            
            // تحديث جدول المخالفات
            document.getElementById('violations-table').innerHTML = renderViolationsTable();
            
            // مسح الحقول
            document.getElementById('violation-citizen').value = '';
            document.getElementById('violation-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('violation-type').value = appData.violationTypes[0];
            document.getElementById('violation-details').value = '';
            document.getElementById('violation-amount').value = '500';
            
            alert('تمت إضافة المخالفة بنجاح');
        }

        // عرض نموذج الاعتراض
        function showObjectionForm(violationId) {
            appData.selectedViolation = violationId;
            const objectionForm = document.getElementById('objection-form');
            objectionForm.classList.remove('hidden');
            document.getElementById('objection-text').focus();
        }

        // تقديم اعتراض
        function submitObjection() {
            const text = document.getElementById('objection-text').value.trim();
            
            if (!text) {
                alert('يرجى كتابة نص الاعتراض');
                return;
            }
            
            const violationIndex = appData.violations.findIndex(v => v.id === appData.selectedViolation);
            
            if (violationIndex !== -1) {
                appData.violations[violationIndex].objection = {
                    text,
                    status: 'pending', // pending, accepted, rejected
                    date: new Date().toISOString()
                };
                
                alert('تم تقديم الاعتراض بنجاح');
                renderCitizenDashboard();
            }
        }

        // البحث عن مواطنين
        function searchCitizens() {
            const searchQuery = document.getElementById('search-citizens').value.trim().toLowerCase();
            
            if (!searchQuery) {
                document.getElementById('citizens-table').innerHTML = renderCitizensTable();
                return;
            }
            
            const filteredCitizens = appData.citizens.filter(c => 
                c.name.toLowerCase().includes(searchQuery) || 
                c.id.includes(searchQuery) ||
                (c.phone && c.phone.includes(searchQuery))
            );
            
            if (filteredCitizens.length === 0) {
                document.getElementById('citizens-table').innerHTML = '<tr><td colspan="5" style="text-align: center;">لا توجد نتائج مطابقة</td></tr>';
                return;
            }
            
            const tableHTML = filteredCitizens.map(citizen => {
                const violationsCount = appData.violations.filter(v => v.citizenId === citizen.id).length;
                return `
                    <tr>
                        <td>${citizen.name}</td>
                        <td>${citizen.id}</td>
                        <td>${citizen.phone || 'غير متوفر'}</td>
                        <td>${violationsCount}</td>
                        <td>
                            <button class="btn btn-warning view-citizen-violations" data-id="${citizen.id}">عرض المخالفات</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('citizens-table').innerHTML = tableHTML;
        }

        // البحث عن مخالفات
        function searchViolations() {
            const searchQuery = document.getElementById('search-violations').value.trim().toLowerCase();
            const searchType = document.getElementById('search-type').value;
            const filterStatus = document.getElementById('filter-status').value;
            
            let filteredViolations = [...appData.violations];
            
            // تطبيق فلتر الحالة
            if (filterStatus === 'paid') {
                filteredViolations = filteredViolations.filter(v => v.paid);
            } else if (filterStatus === 'unpaid') {
                filteredViolations = filteredViolations.filter(v => !v.paid);
            } else if (filterStatus === 'objection') {
                filteredViolations = filteredViolations.filter(v => v.objection);
            }
            
            // تطبيق البحث
            if (searchQuery) {
                if (searchType === 'name') {
                    filteredViolations = filteredViolations.filter(v => {
                        const citizen = appData.citizens.find(c => c.id === v.citizenId);
                        return citizen && citizen.name.toLowerCase().includes(searchQuery);
                    });
                } else if (searchType === 'id') {
                    filteredViolations = filteredViolations.filter(v => v.citizenId.includes(searchQuery));
                } else if (searchType === 'type') {
                    filteredViolations = filteredViolations.filter(v => v.type.toLowerCase().includes(searchQuery));
                }
            }
            
            if (filteredViolations.length === 0) {
                document.getElementById('violations-table').innerHTML = '<tr><td colspan="7" style="text-align: center;">لا توجد نتائج مطابقة</td></tr>';
                return;
            }
            
            const tableHTML = filteredViolations.map(v => {
                const citizen = appData.citizens.find(c => c.id === v.citizenId) || { name: 'غير معروف' };
                let objectionStatus = 'لا يوجد';
                
                if (v.objection) {
                    if (v.objection.status === 'pending') {
                        objectionStatus = 'بانتظار الرد';
                    } else if (v.objection.status === 'accepted') {
                        objectionStatus = 'مقبول';
                    } else if (v.objection.status === 'rejected') {
                        objectionStatus = 'مرفوض';
                    }
                }
                
                return `
                    <tr>
                        <td>${citizen.name}</td>
                        <td>${v.type}</td>
                        <td>${formatDate(v.date)}</td>
                        <td>${v.amount} ريال</td>
                        <td>
                            <span class="status ${v.paid ? 'status-paid' : 'status-unpaid'}">${v.paid ? 'مدفوعة' : 'غير مدفوعة'}</span>
                        </td>
                        <td>
                            <span class="status ${getObjectionStatusClass(v.objection)}">${objectionStatus}</span>
                        </td>
                        <td>
                            <button class="btn view-violation" data-id="${v.id}">عرض</button>
                            <button class="btn ${v.paid ? 'btn-warning mark-unpaid' : 'btn-success mark-paid'}" data-id="${v.id}">
                                ${v.paid ? 'تعديل لغير مدفوعة' : 'تعديل لمدفوعة'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('violations-table').innerHTML = tableHTML;
        }

        // حساب إجمالي المبالغ المستحقة
        function getTotalDueAmount() {
            return appData.violations.reduce((sum, v) => sum + v.amount, 0);
        }

        // حساب المبالغ المدفوعة
        function getTotalPaidAmount() {
            return appData.violations.filter(v => v.paid).reduce((sum, v) => sum + v.amount, 0);
        }

        // حساب عدد الاعتراضات
        function getObjectionsCount() {
            return appData.violations.filter(v => v.objection).length;
        }

        // الحصول على صنف حالة الاعتراض
        function getObjectionStatusClass(objection) {
            if (!objection) return '';
            
            switch (objection.status) {
                case 'pending':
                    return 'status-pending';
                case 'accepted':
                    return 'status-accepted';
                case 'rejected':
                    return 'status-rejected';
                default:
                    return '';
            }
        }

        // تنسيق التاريخ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-SA');
        }

        // توليد معرف فريد
        function generateId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // تبديل التبويبات
        function switchTab(tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.main-content > div').forEach(element => {
                element.classList.add('hidden');
            });
            
            // إزالة التنشيط من جميع الروابط
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            
            // عرض المحتوى المطلوب
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // تنشيط الرابط المطلوب
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // تحديث التبويب النشط
            appData.activeTab = tabName;
        }

        // تسجيل الخروج
        function handleLogout() {
            appData.currentUser = null;
            renderLoginPage();
        }

        // بدء التطبيق
        function initApp() {
            // إضافة بيانات تجريبية
            if (appData.citizens.length === 0) {
                appData.citizens.push(
                    { name: 'أحمد محمد علي', id: '1000000000', phone: '0500000000', password: '1234' },
                    { name: 'محمد سعيد الأحمد', id: '1000000001', phone: '0500000001', password: '1234' },
                    { name: 'خالد عبدالله السعيد', id: '1000000002', phone: '0500000002', password: '1234' }
                );
            }
            
            if (appData.violations.length === 0) {
                appData.violations.push(
                    { 
                        id: 'v1', 
                        citizenId: '1000000000', 
                        date: '2025-05-01', 
                        type: 'سرعة', 
                        details: 'تجاوز السرعة المحددة بمقدار 30 كم/س', 
                        amount: 500, 
                        paid: false, 
                        objection: null 
                    },
                    { 
                        id: 'v2', 
                        citizenId: '1000000001', 
                        date: '2025-05-02', 
                        type: 'تجاوز إشارة حمراء', 
                        details: 'تجاوز الإشارة الحمراء عند تقاطع شارع الملك فهد', 
                        amount: 1000, 
                        paid: true, 
                        objection: null 
                    },
                    { 
                        id: 'v3', 
                        citizenId: '1000000000', 
                        date: '2025-05-03', 
                        type: 'وقوف في مكان ممنوع', 
                        details: 'وقوف في مكان مخصص لذوي الاحتياجات الخاصة', 
                        amount: 300, 
                        paid: false, 
                        objection: { 
                            text: 'لم أكن أعلم أن المكان مخصص لذوي الاحتياجات الخاصة، لم تكن هناك علامات واضحة', 
                            status: 'pending', 
                            date: '2025-05-03' 
                        } 
                    }
                );
            }
            
            // عرض صفحة تسجيل الدخول
            renderLoginPage();
            
            // إضافة مستمع لأحداث المستند
            document.addEventListener('click', function(e) {
                // تعديل حالة الدفع
                if (e.target.classList.contains('mark-paid')) {
                    const violationId = e.target.getAttribute('data-id');
                    const violationIndex = appData.violations.findIndex(v => v.id === violationId);
                    
                    if (violationIndex !== -1) {
                        appData.violations[violationIndex].paid = true;
                        document.getElementById('violations-table').innerHTML = renderViolationsTable();
                    }
                }
                
                if (e.target.classList.contains('mark-unpaid')) {
                    const violationId = e.target.getAttribute('data-id');
                    const violationIndex = appData.violations.findIndex(v => v.id === violationId);
                    
                    if (violationIndex !== -1) {
                        appData.violations[violationIndex].paid = false;
                        document.getElementById('violations-table').innerHTML = renderViolationsTable();
                    }
                }
                
                // معالجة الاعتراضات
                if (e.target.classList.contains('accept-objection')) {
                    const violationId = e.target.getAttribute('data-id');
                    const violationIndex = appData.violations.findIndex(v => v.id === violationId);
                    
                    if (violationIndex !== -1) {
                        appData.violations[violationIndex].objection.status = 'accepted';
                        document.getElementById('objections-table').innerHTML = renderObjectionsTable();
                    }
                }
                
                if (e.target.classList.contains('reject-objection')) {
                    const violationId = e.target.getAttribute('data-id');
                    const violationIndex = appData.violations.findIndex(v => v.id === violationId);
                    
                    if (violationIndex !== -1) {
                        appData.violations[violationIndex].objection.status = 'rejected';
                        document.getElementById('objections-table').innerHTML = renderObjectionsTable();
                    }
                }
            });
        }
        
        // تشغيل التطبيق عند تحميل الصفحة
        window.onload = initApp;
    </script>
</body>
</html>
